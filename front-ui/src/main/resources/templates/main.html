<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<meta charset="UTF-8">
<head>
    <title>Корзина товаров</title>
    <script>
        let latestRates = [];

        // заполняем только один раз при загрузке
        function populateCurrencySelects(rates) {
          const currencyCodes = rates.map(r => ({name: r.name, title: r.title}));

          // селекты, где выбираются валюты
          const selects = [
            ...document.querySelectorAll('select[name="currency"]'),
            ...document.querySelectorAll('select[name="from_currency"]'),
            ...document.querySelectorAll('select[name="to_currency"]'),
          ];

          selects.forEach(sel => {
            sel.innerHTML = '';
            currencyCodes.forEach(c => {
              const opt = document.createElement('option');
              opt.value = c.name;
              opt.textContent = c.title;
              sel.appendChild(opt);
            });
          });
        }

        // обновляем таблицу курсов каждые 5 секунд
        function updateRatesTable(rates) {
          const td = document.getElementById('exchange_rates');
          let table = '<table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">';
          table += '<tr><th colspan="3">Курсы валют по отношению к рублю</th></tr>';
          table += '<tr><th>Валюта</th><th>Обозначение</th><th>Курс</th></tr>';
          rates.forEach(rate => {
            table += `<tr><td>${rate.title}</td><td>${rate.name}</td><td>${rate.value}</td></tr>`;
          });
          table += '</table>';
          td.innerHTML = table;
        }

        // при загрузке страницы
        window.addEventListener('load', () => {
          // первый запрос — получаем список валют и первые курсы
          fetch('front-ui/getRates')
            .then(r => r.json())
            .then(json => {
              latestRates = json;
              populateCurrencySelects(json); // селекты один раз
              updateRatesTable(json);        // таблицу сразу показать
            });

          // дальше только обновляем таблицу
          setInterval(() => {
            fetch('/front-ui/getRates')
              .then(r => r.json())
              .then(json => {
                latestRates = json;
                updateRatesTable(json);
              })
              .catch(() => {
                document.getElementById('exchange_rates').innerText = 'Ошибка при получении данных курсов валют';
              });
          }, 5000);
        });

        // intercept cash form — БЕЗ локальных alert, уведомления показывает notifications
        function cashFormIntercept() {
          const form = document.querySelector('form[action*="/front-ui/user/"][action$="/getCash"]');
          if (!form) return;
          form.addEventListener('submit', function(ev) {
            ev.preventDefault();
            const actionUrl = form.getAttribute('action');
            const formData = new FormData(form);
            // VERY IMPORTANT: include clicked button name/value (e.g., action=PUT/GET)
            const submitter = ev.submitter;
            if (submitter && submitter.name) {
              formData.append(submitter.name, submitter.value || '');
            }
            fetch(actionUrl, { method: 'POST', body: formData })
              .then(async r => {
                // уведомления теперь приходят из notifications-пуллера
                if (!r.ok) {
                  const text = await r.text().catch(() => '');
                  console.error('Ошибка операции:', text || r.status);
                }
              })
              .catch(err => console.error('Сеть недоступна:', err));
          });
        }
        window.addEventListener('load', cashFormIntercept);

        // === ПУЛЛЕР УВЕДОМЛЕНИЙ ИЗ notifications ===
        (function startNotificationsPolling() {
          async function tick() {
            try {
              // идём через gateway на notifications
              const resp = await fetch('/notifications/last', { cache: 'no-store' });
              if (resp.status === 200) {
                const msg = (await resp.text()).trim();
                if (msg) alert(msg); // показываем только сообщения из notifications
              }
            } catch (e) {
              // если notifications временно недоступен — не спамим пользователя
              console.warn('notifications unavailable', e);
            } finally {
              setTimeout(tick, 2000); // опрос каждые ~2 секунды
            }
          }
          if (document.readyState === 'loading') {
            window.addEventListener('load', tick);
          } else {
            tick();
          }
        })();
    </script>

</head>

<body>
<a href="@{/signup}" style="float:right;">
    <b>РЕГИСТРАЦИЯ &plus;</b>
</a>
<br>
<a href="@{/login}" style="float:right;">
    <b>ЛОГИН &plus;</b>
</a>
<br>
<a href="@{/logout}" style="float:right;">
    <b>ВЫЙТИ &cudarrr;</b>
</a>
<table style="width:70%;margin-left:auto;margin-right:auto;">
    <tr><td style="padding:2px;">
        <form method="post" th:action="@{/user/{login}/editPassword(login=${login})}" enctype="application/x-www-form-urlencoded">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr>
                    <td style="font-weight:bold;">Логин</td>
                    <td colspan="2" th:text="${login}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Изменить пароль</td>
                    <td>
                        <p style="color:red;" th:if="${passwordErrors!=null}" th:each="passwordError : ${passwordErrors}" th:text="${passwordError}"/>
                        <p>
                            Пароль: <input name="password" type="password" required/>
                        </p>
                        <p>
                            Повторите пароль: <input name="confirmPassword" type="password" required/>
                        </p>
                    </td>
                    <td style="text-align:right">
                        <button>Изменить пароль</button>
                    </td>
                </tr>
            </table>
        </form>
    </td>
    <tr><td style="padding:2px;">
        <form method="post" th:action="@{/user/{login}/editUserAccounts(login=${login})}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${userAccountsErrors!=null}" th:each="userAccountsError : ${userAccountsErrors}">
                    <td style="color:red;" th:text="${userAccountsError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Фамилия Имя</td>
                    <td th:text="${name}"/>
                    <td>
                        <input name="name" type="text" style="width:100%"/>
                    </td>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Дата рождения</td>
                    <td th:text="${birthdate}"/>
                    <td>
                        <input name="birthdate" type="date" style="width:100%"/>
                    </td>
                </tr>
                <tr th:each="account : ${accounts}">
                    <td style="font-weight:bold;" th:text="${account.getCurrency().getTitle()}"/>
                    <td th:text="${account.isExists() ? (account.getValue()+' '+account.getCurrency().name()) : ''}"/>
                    <td style="text-align:right">
                        <input name="account" type="checkbox" th:checked="${account.isExists()}" th:value="${account.getCurrency().name()}"/>
                    </td>
                </tr>
                <tr>
                    <td style="text-align:right" colspan="3">
                        <button>Сохранить изменения</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="@{/user/{login}/getCash(login=${login})}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${cashErrors!=null}" th:each="cashError : ${cashErrors}">
                    <td style="color:red;" th:text="${cashError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Наличные</td>
                    <td>
                        Валюта
                        <select name="currency">
                            <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.name()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" style="width:100%" required/>
                    </td>
                    <td>
                    <td style="text-align:right">
                        <button name="action" value="PUT">Положить</button>
                        <button name="action" value="GET">Снять</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="@{/user/{login}/doTransfer(login=${login})}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${transferErrors!=null}" th:each="transferError : ${transferErrors}">
                    <td style="color:red;" th:text="${transferError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Перевод себе</td>
                    <td>
                        Со счета
                        <select name="from_currency">
                            <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.name()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        На счет
                        <select name="to_currency">
                            <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.name()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" style="width:100%" required/>
                    </td>
                    <td style="text-align:right">
                        <input hidden name="to_login" th:value="${login}"/>
                        <button>Перевести</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="@{/user/{login}/doTransfer(login=${login})}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${transferOtherErrors!=null}" th:each="transferOtherError : ${transferOtherErrors}">
                    <td style="color:red;" th:text="${transferOtherError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Перевод другому</td>
                    <td>
                        Со счета
                        <select name="from_currency">
                            <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.name()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        На счет
                        <select name="to_currency">
                            <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.name()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" required/>
                    </td>
                    <td>
                        Кому
                        <select name="to_login">
                            <option th:each="user : ${users}" th:value="${user.getLogin()}" th:text="${user.getName()}"/>
                        </select>
                    </td>
                    <td style="text-align:right">
                        <button>Перевести</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;" id="exchange_rates">
    </td></tr>
</table>
</body>

</html>
